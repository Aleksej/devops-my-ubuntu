---

- name: install py-dev linux packages
  apt: name={{ item }} state=latest
  with_items:
   - python-virtualenv
   - python-pip
   - python-dev
   - python-pygments

# support the oh-my-zsh virutalenvwrapper plugin
# => automagically activates the venv when a git repo directory is entered 
- name: install virutalenvwrapper
  pip: name=virtualenvwrapper state=latest
  tags: venvwrapper

# first idea was to place a venv-wrapper.zsh in the .oh-my-zsh/custom folder
# but the oh-my-zsh virtualenvwrapper plugin runs source on virutalenvwrapper.sh
# so config has to happen before the plugin is loaded
- name: configure virtualenvwrapper
  lineinfile: dest=/home/{{ user }}/.zshrc
        insertbefore="^plugins"
        line="export WORKON_HOME={{ venv_home }}"
        state=present
  tags: venvwrapper

# foreach python git repo create the venv with the same name
- name: create one venv foreach pydev repo
  shell: source /home/{{ user }}/.zshrc; mkvirtualenv {{ item }}
         executable=/usr/bin/zsh
  with_items: "{{ pydev_repos }}"
  become_user: "{{ user }}"
  become_method: sudo
  tags: venvwrapper

# TODO
# install packages required by project
# pip -r requirements.txt
- name: install packages into each pydev repo
  pip: name={{ item[1] }}
       virtualenv={{ venv_home }}/{{ item[0] }}
       state=latest
  with_nested:
   - "{{ pydev_repos }}"
   - ["nose", "pyvows", "inject", "sqlalchemy", "agnostic"]
  become_user: "{{ user }}"
  become_method: sudo
  tags: venvwrapper

# assuming git repo is already cloned
- name: bind venv to projects
  shell: source /home/{{ user }}/.zshrc; \
         setvirtualenvproject {{ venv_home }}/{{ item }} {{ project_home }}/{{ item }}
         executable=/usr/bin/zsh
  with_items: "{{ pydev_repos }}"
  become_user: "{{ user }}"
  become_method: sudo
  tags: venvwrapper

